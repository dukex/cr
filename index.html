<!DOCTYPE html>
<html>
  <head>
    <title>Hello World!</title>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style media="screen">
      pre, code{
        font-family: 'Droid Sans Mono';
      }
      li {
        padding: 5px 10px;
        height: 30px;
        line-height: 2
      }
      li.reviewed {
        opacity: 0.6;
        text-decoration: line-through;
      }
      li.reviewed::before{
        content: "done";
        color: green;
        font-family: 'Material Icons';
        text-rendering: optimizeLegibility;
        font-feature-settings: "liga" 1;
        font-style: normal;
        text-transform: none;
        line-height: 1;
        display: inline-block;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
      }

      button.reviewed, button.review, button.unreview {
        border: 1px solid green;
        background-color: #FFF;
        color: rgb(48, 134, 5);
        border-radius: 5px;
        margin: 0 5px;
      }

      button.review {
        border: 1px solid blue;
        color: rgb(22, 60, 134);
      }

      button.unreview {
        border: 1px solid red;
        color: rgb(134, 13, 22);
      }

      li.reviewed button.reviewed, li.reviewed button.review {
        display: none
      }

      button.unreview {
        display: none;
      }

      li.reviewed button.unreview {
        display: inline-block;
      }

      ul#commits {
        list-style: none;
        margin: 0;
        padding: 0;
        font-size: 18px;
        font-family: 'Droid Sans Mono';
      }
      ul#commits b {
        padding: 0 10px 0 0;
      }
      ul#commits span.author {
        color: darkblue;
        font-size: 16px;
      }

      ul#commits span.date {
        color: red;
        font-size: 16px;
      }
    </style>
    <link rel="stylesheet" href="./node_modules/highlight.js/styles/monokai_sublime.css" media="screen" title="no title" charset="utf-8">
  </head>
  <body>
    <div id="diff"></div>
    <ul id="commits">
      <!-- 31asd1313 Commit message - Duke<email>  -->
    </ul>

    <script type="text/javascript">
      var moment = require('moment');
      var h = require('highlight.js');
      h.configure({useBR: true});

      var Firebase = require("firebase");
      var ref = new Firebase("https://intense-torch-1886.firebaseio.com/reviewed");
      var ipc = require('ipc');

      ipc.on('open', function(data) {
        var directory = data[0];
        var authData = ref.getAuth();
        openRepository(directory, authData);
      });

      var authHandler = function(directory) {
        return function(error, authData) {
          if (error && error.code === "TRANSPORT_UNAVAILABLE") {
            alert(error);
          } else {
            openRepository(directory, authData);
          }
        }
      }

      var openRepository = function(directory, authData) {
        if(authData) {
          var open = require("nodegit").Repository.open;
          open(directory)
          .then(function(repo) {
            return Promise.all([repo, repo.getRemote('origin')]);
          })
          .then(function(d){
            var repo = d[0];
            var remote = d[1];
            var name = remote.url().replace(/git\@|\.git/g, "").replace(/\:|\./g, "-")
            var reviewed = ref.child(authData.uid + "/" + name)
            return Promise.all([reviewed, repo.getMasterCommit()]);
          })
          .then(showHistory)
        } else {
          // ref.authWithOAuthPopup("github", authHandler(directory));
          authHandler(directory)(null, {uid: "dukex"})
        }
      }

      var showHistory = function(d) {
        var reviewed = d[0];
        var firstCommitOnMaster = d[1];
        var history = firstCommitOnMaster.history();
        history.on('commit', function(commit) {
          var author = commit.author();
          var li = document.createElement('li');
          var b = document.createElement("b");
          var authorEl = document.createElement("span");
          var dateEl = document.createElement("span");
          var reviewedEl = document.createElement('button');
          var reviewEl = document.createElement('button');
          var unreviewEl = document.createElement('button');

          li.id = "commit-"+ commit.sha().slice(0, 6);
          b.appendChild(document.createTextNode(commit.sha().slice(0, 9)));
          authorEl.appendChild(document.createTextNode(author.name()));
          authorEl.classList.add("author");
          dateEl.appendChild(document.createTextNode(" ("+ moment(commit.date()).fromNow() +")"));
          dateEl.classList.add("date");
          reviewedEl.appendChild(document.createTextNode("thumb_up"));
          reviewedEl.classList.add("material-icons");
          reviewedEl.classList.add("reviewed");
          reviewEl.appendChild(document.createTextNode("search"));
          reviewEl.classList.add("material-icons");
          reviewEl.classList.add('review');
          unreviewEl.appendChild(document.createTextNode("thumb_down"));
          unreviewEl.classList.add("material-icons");
          unreviewEl.classList.add('unreview');

          li.appendChild(b);
          li.appendChild(authorEl);
          li.appendChild(document.createTextNode(" - "));
          li.appendChild(document.createTextNode(commit.message().split(/(?:\r\n|\r|\n)/g)[0]));
          li.appendChild(dateEl);
          li.appendChild(reviewEl);
          li.appendChild(reviewedEl);
          li.appendChild(unreviewEl);
          reviewedEl.addEventListener('click', function (e) {
            reviewed.child(this.sha().slice(0, 6)).set({
              reviewed: true
            });
            e.preventDefault();
          }.bind(commit), false);
          reviewEl.addEventListener('click', function  (e) {
            return this.getDiff().then(function(diffList) {
              lines = [];
              diffList.forEach(function(diff) {
                diff.patches().forEach(function(patch) {
                  lines.push("--- " +patch.oldFile().path());
                  lines.push("+++ " +patch.newFile().path());
                  patch.hunks().forEach(function(hunk) {
                    lines.push(hunk.header());
                    hunk.lines().forEach(function(line) {
                      lines.push(String.fromCharCode(line.origin()) + line.content());
                    });
                  });
                });
              });
              var diff = document.querySelector('#diff');
              diff.innerHTML = "<pre><code class='hljs'>" + h.highlight("diff", lines.join("\n")).value + "</code></pre>";
              window.scroll(0, 0)
            });
          }.bind(commit), false);
          commits.insertAdjacentElement('beforeend', li);
        });

        history.start();
        reviewed.on("value", function (snapshot) {
          if(!snapshot.val()){
            return
          }
          var data = snapshot.val();
          Object.keys(data).forEach(function(sha){
            var commit = document.querySelector("#commit-" + sha);
            if(data[sha].reviewed) {
              commit && commit.classList.add('reviewed');
            }
          })
        })
      };
      </script>
  </body>
</html>
