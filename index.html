<!DOCTYPE html>
<html>
  <head>
    <title>Hello World!</title>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
    <style media="screen">
      pre, code{
        font-family: 'Droid Sans Mono';
      }
      ul#commits {
        list-style: none;
        margin: 0;
        padding: 0;
        font-size: 18px;
        font-family: 'Droid Sans Mono';
      }
      ul#commits b {
        padding: 0 10px 0 0;
      }
      ul#commits span.author {
        color: darkblue;
        font-size: 16px;
      }

      ul#commits span.date {
        color: red;
        font-size: 16px;
      }
    </style>
    <link rel="stylesheet" href="./node_modules/highlight.js/styles/monokai_sublime.css" media="screen" title="no title" charset="utf-8">
  </head>
  <body>
    <div id="diff"></div>
    <ul id="commits">
      <!-- 31asd1313 Commit message - Duke<email>  -->
    </ul>

    <script type="text/javascript">
    var commits = document.querySelector("#commits");
    var moment = require('moment');
    var h = require('highlight.js');
    h.configure({useBR: true});
    var open = require("nodegit").Repository.open;
    open("/home/duke/src/ember-cli-cordova")
    .then(function(repo) {
      return repo.getMasterCommit();
    })
    .then(function(firstCommitOnMaster) {
      var history = firstCommitOnMaster.history();
      history.on('commit', function(commit) {
        var author = commit.author();
        var li = document.createElement('li');
        var b = document.createElement("b");
        var authorEl = document.createElement("span");
        var dateEl = document.createElement("span");

        b.appendChild(document.createTextNode(commit.sha().slice(0, 9)));
        authorEl.appendChild(document.createTextNode(author.name()));
        authorEl.classList.add("author");
        dateEl.appendChild(document.createTextNode(" ("+ moment(commit.date()).fromNow() +")"));
        dateEl.classList.add("date");

        li.appendChild(b);
        li.appendChild(authorEl);
        li.appendChild(document.createTextNode(" - "));
        li.appendChild(document.createTextNode(commit.message().split(/(?:\r\n|\r|\n)/g)[0]));
        li.appendChild(dateEl);

        li.addEventListener('click', function  () {
          return this.getDiff().then(function(diffList) {
            lines = [];
            diffList.forEach(function(diff) {
              diff.patches().forEach(function(patch) {
                lines.push("--- " +patch.oldFile().path());
                lines.push("+++ " +patch.newFile().path());
                patch.hunks().forEach(function(hunk) {
                  lines.push(hunk.header());
                  hunk.lines().forEach(function(line) {
                    lines.push(String.fromCharCode(line.origin()) + line.content());
                  });
                });
              });
            });
            var diff = document.querySelector('#diff');
            diff.innerHTML = "<pre><code class='hljs'>" + h.highlight("diff", lines.join("\n")).value + "</code></pre>";
          });
        }.bind(commit), false);
        commits.insertAdjacentElement('beforeend', li);
      });

      history.start();
    });
    </script>
  </body>
</html>
